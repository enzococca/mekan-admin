{% extends "base.html" %}
{% block title %}Archaeological Data Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>Archaeological Data Management System</h2>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="dataTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="mekan-tab" data-bs-toggle="tab" href="#mekan" role="tab">
                <i class="fas fa-building"></i> MEKAN
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="birin-tab" data-bs-toggle="tab" href="#birin" role="tab">
                <i class="fas fa-layer-group"></i> Birim
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="walls-tab" data-bs-toggle="tab" href="#walls" role="tab">
                <i class="fas fa-border-all"></i> Walls
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="graves-tab" data-bs-toggle="tab" href="#graves" role="tab">
                <i class="fas fa-monument"></i> Graves
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="finds-tab" data-bs-toggle="tab" href="#finds" role="tab">
                <i class="fas fa-gem"></i> Finds
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="map-tab" data-bs-toggle="tab" href="#map" role="tab">
                <i class="fas fa-map-marked-alt"></i> Map
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="stats-tab" data-bs-toggle="tab" href="#stats" role="tab">
                <i class="fas fa-chart-bar"></i> Statistics
            </a>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="dataTabContent">
        
        <!-- MEKAN Tab -->
        <div class="tab-pane fade show active" id="mekan" role="tabpanel">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-building"></i> MEKAN Units</h5>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm" onclick="refreshMekanData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="mekanSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="mekanYear" placeholder="Year">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-dark" onclick="searchMekanData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>MEKAN No</th>
                                    <th>Type</th>
                                    <th>Year</th>
                                    <th>Area</th>
                                    <th>Site</th>
                                    <th>Description</th>
                                    <th>Code</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mekanTableBody"></tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination pagination-sm" id="mekanPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- BIRIM Tab -->
        <div class="tab-pane fade" id="birin" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-layer-group"></i> Birim Units</h5>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm" onclick="refreshBirinData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="birinSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="birinYear" placeholder="Year">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="searchBirinData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Birin No</th>
                                    <th>Type</th>
                                    <th>MEKAN</th>
                                    <th>Year</th>
                                    <th>Area</th>
                                    <th>Description</th>
                                    <th>Coordinates</th>
                                    <th>Excavated By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="birinTableBody"></tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination pagination-sm" id="birinPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- WALLS Tab -->
        <div class="tab-pane fade" id="walls" role="tabpanel">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-border-all"></i> MEKAN Walls</h5>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm" onclick="refreshWallsData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="wallsSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="wallsYear" placeholder="Year">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success" onclick="searchWallsData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Wall No</th>
                                    <th>Year</th>
                                    <th>Area</th>
                                    <th>Type</th>
                                    <th>Thickness (cm)</th>
                                    <th>Material</th>
                                    <th>Description</th>
                                    <th>Preservation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wallsTableBody"></tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination pagination-sm" id="wallsPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- GRAVES Tab -->
        <div class="tab-pane fade" id="graves" role="tabpanel">
            <div class="card">
                <div class="card-header bg-warning">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-monument"></i> MEKAN Graves</h5>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm" onclick="refreshGravesData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="gravesSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="gravesYear" placeholder="Year">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-warning" onclick="searchGravesData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Grave No</th>
                                    <th>Year</th>
                                    <th>Area</th>
                                    <th>Type</th>
                                    <th>Subtype</th>
                                    <th>MEKAN</th>
                                    <th>Description</th>
                                    <th>Preservation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gravesTableBody"></tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination pagination-sm" id="gravesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- FINDS Tab -->
        <div class="tab-pane fade" id="finds" role="tabpanel">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-gem"></i> Finds Catalog</h5>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm" onclick="refreshFindsData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="findsSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="findsMaterial">
                                <option value="">All Materials</option>
                                <option value="Ceramic">Ceramic</option>
                                <option value="Metal">Metal</option>
                                <option value="Stone">Stone</option>
                                <option value="Bone">Bone</option>
                                <option value="Glass">Glass</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-info" onclick="searchFindsData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Find No</th>
                                    <th>Material</th>
                                    <th>MEKAN</th>
                                    <th>Year</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Weight (g)</th>
                                    <th>Registered By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="findsTableBody"></tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination pagination-sm" id="findsPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- MAP Tab -->
        <div class="tab-pane fade" id="map" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-map-marked-alt"></i> Spatial View</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showBirin" checked>
                                <label class="form-check-label" for="showBirin">
                                    Birin Units
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showWalls" checked>
                                <label class="form-check-label" for="showWalls">
                                    Walls
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showGraves" checked>
                                <label class="form-check-label" for="showGraves">
                                    Graves
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showFinds" checked>
                                <label class="form-check-label" for="showFinds">
                                    Finds
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary btn-sm" onclick="loadMapData()">
                                <i class="fas fa-sync"></i> Refresh Map
                            </button>
                        </div>
                    </div>
                    <div id="mapContainer" style="height: 600px; background: #f0f0f0; border-radius: 5px;"></div>
                </div>
            </div>
        </div>
        
        <!-- STATISTICS Tab -->
        <div class="tab-pane fade" id="stats" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Database Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Birin Units</h5>
                                    <h2 id="totalBirin">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Walls</h5>
                                    <h2 id="totalWalls">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Graves</h5>
                                    <h2 id="totalGraves">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Finds</h5>
                                    <h2 id="totalFinds">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Birin by Type</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="birinByTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Finds by Material</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="findsByMaterialChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Excavation Years</h6>
                                </div>
                                <div class="card-body">
                                    <div id="yearsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal with Photos -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle">Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Information</h6>
                        <div id="detailInfo"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Media Files</h6>
                        <div id="detailMedia" class="row g-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let map = null;
let currentPage = { mekan: 1, birin: 1, walls: 1, graves: 1, finds: 1 };

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMekanData();  // Load MEKAN first as it's the active tab
    loadStatistics();
    
    // Tab change handlers
    document.getElementById('birin-tab').addEventListener('shown.bs.tab', () => {
        if (!document.getElementById('birinTableBody').children.length) loadBirinData();
    });
    document.getElementById('walls-tab').addEventListener('shown.bs.tab', () => {
        if (!document.getElementById('wallsTableBody').children.length) loadWallsData();
    });
    document.getElementById('graves-tab').addEventListener('shown.bs.tab', () => {
        if (!document.getElementById('gravesTableBody').children.length) loadGravesData();
    });
    document.getElementById('finds-tab').addEventListener('shown.bs.tab', () => {
        if (!document.getElementById('findsTableBody').children.length) loadFindsData();
    });
    document.getElementById('map-tab').addEventListener('shown.bs.tab', () => {
        if (!map) initializeMap();
    });
});

// ============= MEKAN Functions =============
function loadMekanData(page = 1) {
    currentPage.mekan = page;
    const search = document.getElementById('mekanSearch').value;
    const year = document.getElementById('mekanYear').value;
    
    fetch(`/api/strat_units?page=${page}&search=${search}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('mekanTableBody');
            tbody.innerHTML = '';
            
            data.data.forEach(unit => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${unit.mekan_no || '-'}</td>
                    <td>${unit.mekan_type || '-'}</td>
                    <td>${unit.mekan_year || '-'}</td>
                    <td>${unit.mekan_alan || '-'}</td>
                    <td>${unit.site_id || '-'}</td>
                    <td>${unit.description || '-'}</td>
                    <td>${unit.code || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail('mekan', '${unit.su_uuid}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
            
            updatePagination('mekan', data.page, data.total_pages);
        })
        .catch(err => console.error('Error:', err));
}

function searchMekanData() { loadMekanData(1); }
function refreshMekanData() {
    document.getElementById('mekanSearch').value = '';
    document.getElementById('mekanYear').value = '';
    loadMekanData(1);
}

// ============= BIRIN Functions =============
function loadBirinData(page = 1) {
    currentPage.birin = page;
    const search = document.getElementById('birinSearch').value;
    const year = document.getElementById('birinYear').value;
    
    fetch(`/api/v2/birin?page=${page}&search=${search}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('birinTableBody');
            tbody.innerHTML = '';
            
            data.data.forEach(unit => {
                const coords = unit.koordinat_x && unit.koordinat_y ? 
                    `${unit.koordinat_x}, ${unit.koordinat_y}` : '-';
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${unit.birin_no || '-'}</td>
                    <td>${unit.birin_type || '-'}</td>
                    <td>${unit.mekan_no || '-'}</td>
                    <td>${unit.mekan_year || '-'}</td>
                    <td>${unit.mekan_alan || '-'}</td>
                    <td>${unit.description || '-'}</td>
                    <td>${coords}</td>
                    <td>${unit.excavated_by || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail('birin', '${unit.birin_uuid}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
            
            updatePagination('birin', data.page, data.total_pages);
        })
        .catch(err => console.error('Error:', err));
}

function searchBirinData() { loadBirinData(1); }
function refreshBirinData() {
    document.getElementById('birinSearch').value = '';
    document.getElementById('birinYear').value = '';
    loadBirinData(1);
}

// ============= WALLS Functions =============
function loadWallsData(page = 1) {
    currentPage.walls = page;
    const search = document.getElementById('wallsSearch').value;
    const year = document.getElementById('wallsYear').value;
    
    fetch(`/api/v2/walls?page=${page}&search=${search}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('wallsTableBody');
            tbody.innerHTML = '';
            
            data.data.forEach(wall => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${wall.wall_no || '-'}</td>
                    <td>${wall.wall_year || '-'}</td>
                    <td>${wall.wall_alan || '-'}</td>
                    <td>${wall.wall_type || '-'}</td>
                    <td>${wall.wall_thickness_cm || '-'}</td>
                    <td>${wall.material || '-'}</td>
                    <td>${wall.description || '-'}</td>
                    <td>${wall.preservation_state || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail('wall', '${wall.wall_uuid}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
            
            updatePagination('walls', data.page, data.total_pages);
        })
        .catch(err => console.error('Error:', err));
}

function searchWallsData() { loadWallsData(1); }
function refreshWallsData() {
    document.getElementById('wallsSearch').value = '';
    document.getElementById('wallsYear').value = '';
    loadWallsData(1);
}

// ============= GRAVES Functions =============
function loadGravesData(page = 1) {
    currentPage.graves = page;
    const search = document.getElementById('gravesSearch').value;
    const year = document.getElementById('gravesYear').value;
    
    fetch(`/api/v2/graves?page=${page}&search=${search}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('gravesTableBody');
            tbody.innerHTML = '';
            
            data.data.forEach(grave => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${grave.grave_no || '-'}</td>
                    <td>${grave.grave_year || '-'}</td>
                    <td>${grave.grave_alan || '-'}</td>
                    <td>${grave.grave_type || '-'}</td>
                    <td>${grave.grave_subtype || '-'}</td>
                    <td>${grave.mekan_no || '-'}</td>
                    <td>${grave.description || '-'}</td>
                    <td>${grave.preservation_state || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail('grave', '${grave.grave_uuid}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
            
            updatePagination('graves', data.page, data.total_pages);
        })
        .catch(err => console.error('Error:', err));
}

function searchGravesData() { loadGravesData(1); }
function refreshGravesData() {
    document.getElementById('gravesSearch').value = '';
    document.getElementById('gravesYear').value = '';
    loadGravesData(1);
}

// ============= FINDS Functions =============
function loadFindsData(page = 1) {
    currentPage.finds = page;
    const search = document.getElementById('findsSearch').value;
    const material = document.getElementById('findsMaterial').value;
    
    fetch(`/api/v2/finds?page=${page}&search=${search}&material=${material}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('findsTableBody');
            tbody.innerHTML = '';
            
            data.data.forEach(find => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${find.find_number || '-'}</td>
                    <td>${find.material_type || '-'}</td>
                    <td>${find.mekan_no || '-'}</td>
                    <td>${find.mekan_year || '-'}</td>
                    <td>${find.description || '-'}</td>
                    <td>${find.quantity || '-'}</td>
                    <td>${find.weight_g || '-'}</td>
                    <td>${find.registered_by || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail('find', '${find.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
            
            updatePagination('finds', data.page, data.total_pages);
        })
        .catch(err => console.error('Error:', err));
}

function searchFindsData() { loadFindsData(1); }
function refreshFindsData() {
    document.getElementById('findsSearch').value = '';
    document.getElementById('findsMaterial').value = '';
    loadFindsData(1);
}

// ============= VIEW DETAIL with MEDIA =============
function viewDetail(type, id) {
    document.getElementById('detailModalTitle').textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Details`;
    
    // Load media files
    fetch(`/api/v2/media/${type}/${id}`)
        .then(response => response.json())
        .then(data => {
            const mediaDiv = document.getElementById('detailMedia');
            mediaDiv.innerHTML = '';
            
            if (data.media && data.media.length > 0) {
                data.media.forEach(media => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    
                    if (media.file_type && media.file_type.startsWith('image')) {
                        col.innerHTML = `
                            <div class="card">
                                <img src="${media.public_url}" class="card-img-top" alt="${media.description || 'Photo'}">
                                <div class="card-body p-1">
                                    <small>${media.description || media.file_name}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        col.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <i class="fas fa-file fa-3x"></i>
                                    <p>${media.file_name}</p>
                                    <a href="${media.public_url}" target="_blank" class="btn btn-sm btn-primary">
                                        Download
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                    mediaDiv.appendChild(col);
                });
            } else {
                mediaDiv.innerHTML = '<p class="text-muted">No media files available</p>';
            }
        })
        .catch(err => {
            document.getElementById('detailMedia').innerHTML = '<p class="text-danger">Error loading media</p>';
        });
    
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

// ============= PAGINATION =============
function updatePagination(type, currentPage, totalPages) {
    const paginationEl = document.getElementById(`${type}Pagination`);
    paginationEl.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    const loadFunc = `load${type.charAt(0).toUpperCase() + type.slice(1)}Data`;
    
    // Previous
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="${loadFunc}(${currentPage - 1})">Previous</a>`;
    paginationEl.appendChild(prevLi);
    
    // Pages
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="${loadFunc}(${i})">${i}</a>`;
        paginationEl.appendChild(li);
    }
    
    // Next
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="${loadFunc}(${currentPage + 1})">Next</a>`;
    paginationEl.appendChild(nextLi);
}

// ============= MAP =============
function initializeMap() {
    map = L.map('mapContainer').setView([38.3184, 35.4839], 15); // Kültepe coordinates
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    loadMapData();
}

function loadMapData() {
    if (!map) return;
    
    // Clear existing layers
    map.eachLayer(layer => {
        if (layer instanceof L.GeoJSON) map.removeLayer(layer);
    });
    
    fetch('/api/v2/spatial/all')
        .then(response => response.json())
        .then(data => {
            const colors = {
                'birin': '#3388ff',
                'wall': '#33ff33',
                'grave': '#ff8833',
                'find': '#ff3388'
            };
            
            L.geoJSON(data, {
                style: feature => ({
                    color: colors[feature.properties.layer] || '#000',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.3
                }),
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`
                        <b>${feature.properties.label}</b><br>
                        Type: ${feature.properties.type || feature.properties.material || '-'}<br>
                        ${feature.properties.description || ''}
                    `);
                },
                filter: feature => {
                    const layer = feature.properties.layer;
                    if (layer === 'birin') return document.getElementById('showBirin').checked;
                    if (layer === 'wall') return document.getElementById('showWalls').checked;
                    if (layer === 'grave') return document.getElementById('showGraves').checked;
                    if (layer === 'find') return document.getElementById('showFinds').checked;
                    return true;
                }
            }).addTo(map);
        })
        .catch(err => console.error('Map error:', err));
}

// ============= STATISTICS =============
function loadStatistics() {
    fetch('/api/v2/statistics')
        .then(response => response.json())
        .then(data => {
            // Update totals
            document.getElementById('totalBirin').textContent = data.total_birin || 0;
            document.getElementById('totalWalls').textContent = data.total_walls || 0;
            document.getElementById('totalGraves').textContent = data.total_graves || 0;
            document.getElementById('totalFinds').textContent = data.total_finds || 0;
            
            // Birin by Type Chart
            if (data.birin_by_type && data.birin_by_type.length > 0) {
                new Chart(document.getElementById('birinByTypeChart'), {
                    type: 'bar',
                    data: {
                        labels: data.birin_by_type.map(i => i.birin_type),
                        datasets: [{
                            label: 'Count',
                            data: data.birin_by_type.map(i => i.count),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
            
            // Finds by Material Chart
            if (data.finds_by_material && data.finds_by_material.length > 0) {
                new Chart(document.getElementById('findsByMaterialChart'), {
                    type: 'pie',
                    data: {
                        labels: data.finds_by_material.map(i => i.material_type),
                        datasets: [{
                            data: data.finds_by_material.map(i => i.count),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ]
                        }]
                    },
                    options: { responsive: true }
                });
            }
            
            // Years list
            if (data.excavation_years) {
                const yearsList = document.getElementById('yearsList');
                yearsList.innerHTML = data.excavation_years.map(year => 
                    `<span class="badge bg-secondary me-2">${year}</span>`
                ).join('');
            }
        })
        .catch(err => console.error('Stats error:', err));
}
</script>
{% endblock %}